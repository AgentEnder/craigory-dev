import{r as t,j as e}from"./chunk-D5HdQM_v.js";import{n as ae,L as oe}from"./chunk-BjVEBXCY.js";function le({onMovementData:c}){const i=t.useRef(null),j=t.useRef(null),u=t.useRef(null),v=t.useRef(null);t.useEffect(()=>{let p,w=!0;return(async()=>{try{const r=await navigator.mediaDevices.getUserMedia({video:{width:320,height:240,facingMode:"user"}});v.current=r,i.current&&(i.current.srcObject=r,i.current.play());const x=()=>{if(!w||!i.current||!j.current)return;const l=i.current,y=j.current,E=y.getContext("2d");if(!E||l.videoWidth===0||l.videoHeight===0){p=requestAnimationFrame(x);return}y.width=l.videoWidth,y.height=l.videoHeight,E.drawImage(l,0,0,y.width,y.height);const N=E.getImageData(0,0,y.width,y.height);if(u.current){const C=I(u.current,N);c(C)}u.current=N,p=requestAnimationFrame(x)};i.current&&(i.current.onloadedmetadata=()=>{x()})}catch(r){console.warn("Could not access webcam:",r);const x=setInterval(()=>{if(!w){clearInterval(x);return}c(0)},100)}})(),()=>{w=!1,p&&cancelAnimationFrame(p),v.current&&v.current.getTracks().forEach(r=>r.stop())}},[c]);const I=(p,w)=>{let S=0;const r=p.data,x=w.data;for(let l=0;l<r.length;l+=16){const y=Math.abs(r[l]-x[l])+Math.abs(r[l+1]-x[l+1])+Math.abs(r[l+2]-x[l+2]);S+=y}return Math.min(100,S/(r.length/4)*100)};return e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:i,style:{position:"absolute",top:"-1000px",left:"-1000px",width:"1px",height:"1px",opacity:0},muted:!0,playsInline:!0}),e.jsx("canvas",{ref:j,style:{position:"absolute",top:"-1000px",left:"-1000px",width:"1px",height:"1px",opacity:0}})]})}function ie({onPermissionGranted:c}){const i=t.useRef(null),j=t.useRef(null),[u,v]=t.useState("pending"),[I,p]=t.useState(!1),w=async()=>{p(!0);try{const r=await navigator.mediaDevices.getUserMedia({video:{width:320,height:240,facingMode:"user"}});j.current=r,i.current&&(i.current.srcObject=r,i.current.play()),v("granted"),c()}catch(r){console.warn("Could not access webcam:",r),v("denied")}finally{p(!1)}};t.useEffect(()=>(w(),()=>{j.current&&j.current.getTracks().forEach(r=>r.stop())}),[]);const S=()=>{v("pending"),w()};return e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Webcam Setup"}),e.jsx("div",{className:"space-y-4",children:u==="pending"||I?e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Requesting webcam access..."})]}):u==="granted"?e.jsxs("div",{children:[e.jsx("div",{className:"mb-3",children:e.jsx("video",{ref:i,className:"w-full max-w-xs mx-auto rounded border bg-gray-100",muted:!0,playsInline:!0,autoPlay:!0})}),e.jsxs("div",{className:"flex items-center justify-center text-green-600",children:[e.jsx("svg",{className:"w-5 h-5 mr-2",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),e.jsx("span",{className:"text-sm font-medium",children:"Webcam connected"})]}),e.jsx("p",{className:"text-xs text-gray-500 text-center mt-2",children:"Movement tracking will be active during the assessment"})]}):e.jsxs("div",{children:[e.jsx("div",{className:"text-center mb-4",children:e.jsx("div",{className:"w-full max-w-xs mx-auto h-40 bg-gray-100 rounded border flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("svg",{className:"w-12 h-12 text-gray-400 mx-auto mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"}),e.jsx("line",{x1:"1",y1:"1",x2:"23",y2:"23",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Webcam access denied"})]})})}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded p-3 mb-4",children:e.jsxs("p",{className:"text-sm text-yellow-800",children:[e.jsx("strong",{children:"Note:"})," The assessment can continue without webcam access, but movement tracking will not be available."]})}),e.jsx("button",{onClick:S,className:"w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition-colors text-sm",children:"Retry Webcam Access"})]})})]})}function fe({isPractice:c,practiceDuration:i=60,onComplete:j}){const[u,v]=t.useState(!1),[I,p]=t.useState(0),[w,S]=t.useState(!1),[r,x]=t.useState(3),[l,y]=t.useState(!1),[E,N]=t.useState(""),C=t.useRef(null),R=t.useRef(null),m=t.useRef(null),D=t.useRef([]),T=t.useRef(0),H=t.useRef(0),z=t.useRef(0),A=t.useRef([]),k=t.useRef(!1),L=t.useRef(0),W=t.useRef([]),O=t.useRef(0),M=c?i:1200,Z=()=>500+Math.random()*350,_=()=>1500+Math.random()*2500,B=n=>new Promise(s=>setTimeout(s,n)),F=()=>{const n=C.current;if(!n)return;const s=n.getContext("2d");s&&s.clearRect(0,0,n.width,n.height)},ee=n=>{const s=C.current;if(!s)return;const a=s.getContext("2d");if(!a)return;F();const d=s.width/2,b=s.height/2,g=60;a.fillStyle=n.color==="blue"?"#3b82f6":"#ef4444",n.type==="circle"?(a.beginPath(),a.arc(d,b,g/2,0,2*Math.PI),a.fill()):a.fillRect(d-g/2,b-g/2,g,g)},V=[{type:"circle",color:"blue",id:"blue-circle"},{type:"circle",color:"red",id:"red-circle"},{type:"square",color:"blue",id:"blue-square"},{type:"square",color:"red",id:"red-square"}],X=t.useCallback(()=>V[Math.floor(Math.random()*V.length)],[]),P=t.useCallback(n=>{if(n.code==="Space"&&console.log("Space pressed:",{hasCurrentShape:!!R.current,isRunning:k.current,currentShape:R.current,previousShape:m.current}),n.code!=="Space"||!k.current)return;n.preventDefault();const s=Date.now(),a=s-T.current;let d=!1;R.current&&m.current?d=R.current.type===m.current.type&&R.current.color===m.current.color:d=!1;const b={timestamp:s,correct:d,reactionTime:a};D.current.push(b);const g={type:"response",timestamp:s-O.current,data:{responseTime:s,correct:d,reactionTime:a}};W.current.push(g),c&&N(`Response: ${d?"✓ Correct":"✗ Incorrect"} (${Math.round(a)}ms)`)},[c]),te=t.useCallback(async()=>{try{document.fullscreenElement||await document.documentElement.requestFullscreen()}catch(s){console.warn("Could not enter fullscreen:",s)}S(!0),x(3);const n=setInterval(()=>{x(s=>s<=1?(clearInterval(n),S(!1),v(!0),0):s-1)},1e3)},[]),Y=t.useCallback(()=>{v(!1),k.current=!1,L.current++,F(),R.current=null,m.current=null;const n=D.current,s=H.current,a=n.filter(o=>o.correct).length,d=n.filter(o=>!o.correct).length,b=z.current,g=a+d+b,h=g>0?a/g*100:d===0?100:0,f=n.map(o=>o.reactionTime),G=f.length>0?f.reduce((o,q)=>o+q,0)/f.length:0,K=A.current.length>0?A.current.reduce((o,q)=>o+q,0)/A.current.length:0,Q={accuracy:h,correctResponses:a,incorrectResponses:d,missedResponses:b,averageReactionTime:G,reactionTimes:f,movementScore:K,totalShapes:s,duration:M,timeline:W.current.slice()};document.fullscreenElement&&document.exitFullscreen(),j(Q)},[j,M]),ne=t.useCallback(n=>{A.current.push(n)},[]);t.useEffect(()=>{if(!u)return;D.current=[],T.current=0,H.current=0,z.current=0,A.current=[],W.current=[],O.current=Date.now();const n=async()=>{try{document.fullscreenElement||await document.documentElement.requestFullscreen()}catch(h){console.warn("Could not enter fullscreen:",h)}},s=()=>{u&&!document.fullscreenElement&&n()};document.addEventListener("fullscreenchange",s),p(M);const a=Date.now(),d=setInterval(()=>{const h=Date.now()-a,f=Math.max(0,M-Math.floor(h/1e3));p(f),f<=0&&(clearInterval(d),Y())},1e3),b=++L.current;k.current=!0;const g=async()=>{try{for(await B(2e3),c&&N("Starting assessment loop...");k.current&&u&&L.current===b;){const h=Z(),f=_(),G=h+f,K=Date.now()-a;if((M-Math.floor(K/1e3))*1e3<G+1e3)break;const o=X();c&&N(`Next: Shape ${Math.round(h)}ms | Blank ${Math.round(f)}ms`),m.current=R.current,R.current=o,ee(o),T.current=Date.now(),H.current++;const q=m.current&&o.type===m.current.type&&o.color===m.current.color,se={type:"shape",timestamp:T.current-O.current,data:{shape:{type:o.type,color:o.color,id:o.id},displayDuration:h,shouldMatch:!!q}};if(W.current.push(se),c&&N(`Showing shape for ${Math.round(h)}ms`),await B(h),!k.current||!u||L.current!==b)break;const re=Date.now();if(F(),c&&N(`Blank period: ${Math.round(f)}ms | Total responses: ${D.current.length}`),await B(f),m.current&&o.type===m.current.type&&o.color===m.current.color)if(D.current.some($=>$.timestamp>=T.current&&$.timestamp<=re+f))c&&console.log("User responded correctly to matching shape");else{z.current++;const $=W.current.slice().reverse().find(ce=>ce.type==="shape");$&&($.data.wasMissed=!0),c&&console.log("Missed response - should have pressed space")}else c&&console.log("No match - user should NOT press space")}F(),R.current=null,m.current=null,c&&N("Assessment ending - blank screen"),await B(1e3)}catch(h){console.error("Assessment loop error:",h)}};return console.log(`Starting assessment loop ${b}`),g(),()=>{document.removeEventListener("fullscreenchange",s),clearInterval(d),k.current=!1,L.current++,F(),R.current=null,m.current=null}},[u,X,Y,M]),t.useEffect(()=>{const n=C.current;n&&typeof window<"u"&&(n.width=window.innerWidth,n.height=window.innerHeight)},[]),t.useEffect(()=>(document.addEventListener("keydown",P),()=>document.removeEventListener("keydown",P)),[P]);const U=t.useCallback(n=>{n.key==="Escape"&&u&&(n.preventDefault(),v(!1),document.fullscreenElement&&document.exitFullscreen(),ae("/"))},[u]);t.useEffect(()=>(document.addEventListener("keydown",U),()=>document.removeEventListener("keydown",U)),[U]);const J=n=>{const s=Math.floor(n/60),a=n%60;return`${s}:${a.toString().padStart(2,"0")}`};return w?e.jsx("div",{className:"fullscreen-assessment flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-8xl font-bold text-gray-800 mb-4",children:r}),e.jsx("div",{className:"text-2xl text-gray-600",children:"Get ready..."})]})}):!u&&!w?e.jsxs("div",{className:"max-w-3xl mx-auto py-8 px-4",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:c?"Practice Session":"Full Assessment"}),e.jsxs("p",{className:"text-lg text-gray-600",children:["Duration: ",J(M)]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Instructions"}),e.jsxs("ul",{className:"space-y-2 text-gray-700",children:[e.jsx("li",{children:"• Watch for shapes appearing in the center of the screen"}),e.jsxs("li",{children:["• Press"," ",e.jsx("kbd",{className:"px-2 py-1 bg-gray-100 rounded text-sm",children:"SPACEBAR"})," ","when current shape matches the previous one"]}),e.jsx("li",{children:"• Shapes appear for random durations with random intervals"}),e.jsx("li",{children:"• Keep your attention focused on the center"}),e.jsxs("li",{children:["• Press"," ",e.jsx("kbd",{className:"px-2 py-1 bg-gray-100 rounded text-sm",children:"ESC"})," ","to exit early"]})]})]}),e.jsx(ie,{onPermissionGranted:()=>y(!0)})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx(oe,{href:"/",className:"flex-1 bg-gray-600 text-white py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors font-medium inline-block text-center no-underline",children:"Back"}),e.jsxs("button",{onClick:te,className:"flex-1 bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition-colors font-medium",children:["Start ",c?"Practice":"Assessment"]})]}),!l&&e.jsx("p",{className:"text-sm text-gray-500 text-center mt-2",children:"Webcam setup recommended for movement tracking"})]})]}):e.jsxs("div",{className:"fullscreen-assessment",children:[e.jsx(le,{onMovementData:ne}),e.jsx("div",{className:"absolute top-4 right-4 text-xl font-mono text-gray-600",children:J(I)}),c&&E&&e.jsx("div",{className:"absolute top-4 left-4 text-sm font-mono text-gray-500",children:E}),e.jsx("canvas",{ref:C,width:typeof window<"u"?window.innerWidth:1920,height:typeof window<"u"?window.innerHeight:1080,className:"absolute inset-0 pointer-events-none",style:{width:"100vw",height:"100vh"}}),e.jsx("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 text-center text-gray-500",children:e.jsx("p",{children:"Press SPACEBAR when shapes match | Press ESC to exit"})})]})}export{fe as A};
